"
" Some general settings
"

filetype plugin indent on
syntax on

set ttyfast               " Faster redrawing
set lazyredraw            " Only when necessary
set encoding=utf-8
set incsearch             " Incremental search
set hlsearch              " Highlight search term
set ignorecase            " Search is case insensitive
set smartcase             " Unless your search has capital letters
set mouse=a               " Allow mouse integration
" set switchbuf=newtab      " New buffer always on new tab (useful for :Ack)


" Better 'find' command (autocompletion and some ignored folders)
set path+=**                           " Search files subdirectories
set wildmenu                           " Allow autocomplete on 'find' command
set wildignore+=**/node_modules/**
set wildignore+=**/dist/**
set wildignore+=**/cov/**
set wildignore+=**/coverage/**
set wildignore+=**/po/**
set wildignore+=**/lang/**


" Delete key sometimes does not work, here's the fix
set backspace=indent,eol,start


" Keep undo history across sessions by storing it in a file
if has('persistent_undo')
  let undo_dir = expand('$HOME/.vim/undo_dir')
  if !isdirectory(undo_dir)
    call mkdir(undo_dir, "", 0700)
  endif
  set undodir=$HOME/.vim/undo_dir
  set undofile
endif


"
" Key mapping
"

" Remap leader key
let mapleader = ","

" Disable Ex Mode
nnoremap Q <Nop>

" Ctrl+s saves file in normal/insert mode
nnoremap <c-s> <esc>:w<CR>
inoremap <c-s> <esc>:w<CR>

" Ctrl+t new tab
nnoremap <c-t> <esc>:tabe<cr>

" Ctrl+q close file
nnoremap <c-q> <esc>:q<cr>

" Format file indentation
nnoremap <Leader><Tab> <esc>gg=G``zz

" Open ACK search tool for current word
nnoremap <Leader>f :Ack <cword><cr>

" Navigate through git changes on file
nnoremap <Leader>g :GitGutterNextHunk<cr>
nnoremap <Leader>G :GitGutterPrevHunk<cr>

" Navigate through ALE's error/warnings
nnoremap <Leader>a :ALENext<cr>
nnoremap <Leader>A :ALEPrevious<cr>

" Go to tag
nnoremap ] :ALEGoToDefinition<CR>

" Use Tab for emmet
imap <expr> <tab> emmet#expandAbbrIntelligent("\<tab>")

" Disable arrow keys
nnoremap <Up> <Nop>
nnoremap <Down> <Nop>
nnoremap <Left> <Nop>
nnoremap <Right> <Nop>

" Easier block indentation
vnoremap < <gv
vnoremap > >gv

" Identify the syntax group of the word at the cursor
map <Leader>h :echo "hi<" . synIDattr(synID(line("."),col("."),1),"name") . '> trans<'
      \ . synIDattr(synID(line("."),col("."),0),"name") . "> lo<"
      \ . synIDattr(synIDtrans(synID(line("."),col("."),1)),"name") . ">"<CR>

"
" Autocommands
"

" Reload vimrc file on save
autocmd! bufwritepost .vimrc source $MYVIMRC

" Reload gitgutter on save
autocmd BufWritePost * GitGutter

"
" Indentation settings (let editorconfig handle number of spaces)
"
set expandtab shiftround smartindent autoindent

"
" PLUGINS. VimPlug will download and install all of them
"

" Start plugins
call plug#begin('~/.vim/plugged')

" Git plugins
Plug 'airblade/vim-gitgutter'                   " Show changes on each line
Plug 'tpope/vim-fugitive'                       " A lot of awesome things with git

" Editting tools
Plug 'terryma/vim-multiple-cursors'             " Find all and edit
Plug 'tpope/vim-commentary'                     " Toggle comments
Plug 'christoomey/vim-system-copy'              " Copy to system clipboard with 'cp'
Plug 'tpope/vim-surround'                       " Surround words with brackets/quoutes/etc
Plug 'jiangmiao/auto-pairs'                     " Autoclose brackets, etc

" Search tools
Plug 'mileszs/ack.vim'                          " Find in all files
Plug 'brooth/far.vim'                           " Find and replace in all files
Plug 'ctrlpvim/ctrlp.vim'                       " Fuzzy finder

" Navigation tools
Plug 'christoomey/vim-tmux-navigator'           " Navigation between vim/tmux panes

" File tools
Plug 'danro/rename.vim'                         " Rename the current file with :Rename

" Html tools
Plug 'mattn/emmet-vim'                          " Very cool html snippets
Plug 'gregsexton/MatchTag'                      " Highlight matching html tag

" Syntax tools
Plug 'w0rp/ale'                                 " Syntax checker
Plug 'editorconfig/editorconfig-vim'            " Use custom indentation and syntax (global/project .editorconfig)
Plug 'prettier/vim-prettier'                    " Prettier JS
Plug 'leafgarland/typescript-vim'               " Typescript syntax
Plug 'mxw/vim-jsx'                              " Jsx syntax
Plug 'pangloss/vim-javascript'                  " Improved JS syntax

" Colors
Plug 'chriskempson/base16-vim'                  " Base16 colorschemes

" End of plugins
call plug#end()

"
" Settings after plugins
"

" Colors configuration
if exists('$TMUX') " Make tmux have the right colors
  " Colors in tmux
  let &t_8f = "\<Esc>[38;2;%lu;%lu;%lum"
  let &t_8b = "\<Esc>[48;2;%lu;%lu;%lum"
endif
set termguicolors
set background=dark
colo base16-solarized-dark

" CtrlP config
let g:ctrlp_user_command = 'fd --type file --color never "" %s -E po/'

" Ale syntax config
let sd = matchstr(getcwd(), 'superdesk')
if empty(sd)
  let g:ale_linters = {
  \  'javascript': ['standard'],
  \  'typescript': ['tsserver']
  \}
  let g:ale_fixers = {
  \  'javascript': ['standard'],
  \  'typescript': ['standard']
  \}
else
  let g:ale_linters = {
  \  'javascript': ['eslint'],
  \  'typescript': ['tsserver']
  \}
  let g:ale_fixers = {
  \  'javascript': ['eslint'],
  \  'typescript': ['tslint']
  \}
endif
let g:ale_fix_on_save = 1 " Fix files on save
let g:ale_completion_enabled = 1 " Try to complete stuff


" Ack uses 'ag' instead of 'grep'
let g:ackprg = 'ag --nogroup --column'

" ALLOW JSX SYNTAX IN JS
let g:jsx_ext_required = 0

" Commands
"" Lint js with eslint
command! ES :let g:ale_linters = { 'javascript': ['eslint'], 'typescript': ['eslint'] } | :let g:ale_fixers = { 'javascript': ['eslint'], 'typescript': ['eslint'] }
"" Lint js with standard
command! ST :let g:ale_linters = { 'javascript': ['standard'] } | :let g:ale_fixers = { 'javascript': ['standard'] }
"" Lint ts with tslint
command! TS :let g:ale_linters = { 'typescript': ['tslint'] } | :let g:ale_fixers = { 'typescript': ['tslint'] }
"" Disable js linters
command! NO :let g:ale_linters = { 'javascript': [] } | :let g:ale_fixers = { 'javascript': [] }
