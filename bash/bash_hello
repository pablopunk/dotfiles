#!/usr/bin/env node

const { access, readFile, writeFile, constants } = require('fs')
const { get } = require('https')
const green = str => `\x1b[32m${str}\x1b[39m`
const blue = str => `\x1b[34m${str}\x1b[39m`
const cache = '/tmp/bash_hello'

access(cache, constants.R_OK, (err) => {
  if (!err) {
    readFile(cache, 'utf-8', (_, data) => console.log('\n' + data))
    return
  }

  get('https://soccer.now.sh/spain/real-madrid?timezone=Europe/Madrid', res => {
    let data = ''

    res.on('data', _ => data += _)
    res.on('end', _ => {
      let { matches } = JSON.parse(data)
      let longestGame = 0
      let longestDate = 0
      matches = matches
        .filter(_ => !_.played)
        .slice(0, 3)
      matches.map(m => {
        if (m.game.length > longestGame) {
          longestGame = m.game.length
        }
        if ((m.date.length + m.time.length + 3) > longestDate) {
          longestDate = (m.date.length + m.time.length + 3)
        }
      })
      const output = matches
        .reduce((acc, { game, date, time, tvs }) => {
          const niceGame = game.padEnd(longestGame)
          const niceDate = `${date} (${time})`.padEnd(longestDate)
          return acc + `${green(niceGame)}  ${niceDate}  ${blue(tvs[0])}\n`
        }, '')
      console.log(`\n${output}\n`)
      writeFile(cache, output, 'utf-8', _ => _)
    })
  })
})
