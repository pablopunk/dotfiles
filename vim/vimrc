"
" Some general settings
"

filetype plugin indent on
syntax on

set ttyfast                    " Faster redrawing
set lazyredraw                 " Only when necessary
set encoding=utf-8             " Unicode
set incsearch                  " Incremental search
set hlsearch                   " Highlight search term
set ignorecase                 " Search is case insensitive
set smartcase                  " Unless your search has capital letters
set mouse=a                    " Allow mouse integration
set backspace=indent,eol,start " Fix delete key
set showtabline=2              " Always show tabs
set cursorline                 " Highlight cursor line
set noshowmode                 " Don't show the mode you're in
set number                     " Don't worry I'll change this quick


function! g:TryToGoToDef()
  if exists('TernDef')
    TernDef
  else
    ALEGoToDefinition
  endif
endfunction

"
" Key mapping
"

" Remap leader key
let mapleader = "\<space>"

" Disable Ex Mode
nnoremap Q <Nop>

" Ctrl+c is ESC (it is by default but it won't trigger autocommands)
inoremap <c-c> <esc>

" Ctrl+s saves file in normal/insert mode
nnoremap <c-s> <esc>:w<CR>
inoremap <c-s> <esc>:w<CR>

" Ctrl+hjkl moves split focus
nnoremap <c-h> <c-w>h
nnoremap <c-j> <c-w>j
nnoremap <c-k> <c-w>k
nnoremap <c-l> <c-w>l

" Navigate through buffers
nnoremap gb :bn<cr>
nnoremap gB :bp<cr>

" Ctrl+t new tab
nnoremap <c-t> :tabe<cr>

" Ctrl+q close buffer
nnoremap <c-q> :bd<cr>

" Format file indentation
nnoremap <leader><Tab> <esc>gg=G``zz

" Open ACK search tool for current word
nnoremap <leader>f :Ack <cword><cr>

" Navigate through git changes on file
nnoremap <leader>g :GitGutterNextHunk<cr>
nnoremap <leader>G :GitGutterPrevHunk<cr>

" Navigate through ALE's error/warnings
nnoremap <leader>a :ALENext<cr>
nnoremap <leader>A :ALEPrevious<cr>

" Toggle bookmark on line
nnoremap <leader>b :BookmarkToggle<cr>

" Navigate bookmarks
nnoremap <leader>n :BookmarkNext<cr>
nnoremap <leader>N :BookmarkPrev<cr>

" Open terminal
nnoremap <leader>t :terminal<cr>

" Open .vimrc
nnoremap <leader>v :e ~/.vimrc<cr>

" Go to def (tern)
nnoremap <leader>d :call TryToGoToDef()<cr>

" 0 goes to first indentation
nnoremap 0 ^

" Go to tag
nnoremap ] :ALEGoToDefinition<CR>

" Toggle zen mode
nnoremap <leader>z :Goyo<cr>

" Use CtrlP to search in buffers with leader+leader
nnoremap <leader><leader> :CtrlPBuffer<cr>

" Use CtrlP to search in the current file dir
nnoremap <c-s-p> :CtrlPCurWD<cr>

" Use leader+1 to open todo.txt on new tab
nnoremap <leader>1 :tabe ~/todo.txt<cr>

" Use Tab for emmet
imap <expr> <tab> emmet#expandAbbrIntelligent("\<tab>")

" Use ctrl+F to trigger file completion
inoremap <c-f> <c-x><c-f>

" Use ctrl+O for omnicompletion
inoremap <c-o> <c-x><c-o>

" Disable arrow keys
nnoremap <Up> <Nop>
nnoremap <Down> <Nop>
nnoremap <Left> <Nop>
nnoremap <Right> <Nop>

" Easier block indentation
vnoremap < <gv
vnoremap > >gv

" Map ESC key to exit insert mode in :terminal (vim8 or neovim)
if has('terminal') || has('nvim')
  tnoremap <Esc> <C-\><C-n>
endif

" Identify the syntax group of the word at the cursor
map <leader>h :echo "hi<" . synIDattr(synID(line("."),col("."),1),"name") . '> trans<'
      \ . synIDattr(synID(line("."),col("."),0),"name") . "> lo<"
      \ . synIDattr(synIDtrans(synID(line("."),col("."),1)),"name") . ">"<CR>

"
" Autocommands
"

" Reload gitgutter on save
autocmd BufWritePost * GitGutter

"
" Indentation settings (let editorconfig handle number of spaces)
"
set expandtab shiftround smartindent autoindent

"
" PLUGINS. VimPlug will download and install all of them
"

" Start plugins
call plug#begin('~/.vim/plugged')

" Project
Plug 'airblade/vim-gitgutter'                   " Show changes on each line
Plug 'tpope/vim-fugitive'                       " A lot of awesome things with git
Plug 'editorconfig/editorconfig-vim'            " Custom indentation and syntax per project

" Keybindings
Plug 'christoomey/vim-tmux-navigator'           " Navigate between tmux and vim panes
Plug 'christoomey/vim-system-copy'              " Copy to system clipboard with 'cp'

" Edit
Plug 'pablopunk/persistent-undo.vim'            " Persistent undo across sessions
Plug 'pablopunk/hot-reload.vim'                 " Reload vimrc on save
Plug 'pablopunk/dynamic-file-completion.vim'    " Current directory for <c-x><c-f>
Plug 'terryma/vim-multiple-cursors'             " Find all and edit
Plug 'tpope/vim-commentary'                     " Toggle comments
Plug 'tpope/vim-surround'                       " Surround words with brackets/quoutes/etc
Plug 'tpope/vim-repeat'                         " . command does more
Plug 'jiangmiao/auto-pairs'                     " Autoclose brackets, etc

" Search
Plug 'pablopunk/better-find.vim'                " Better find command
Plug 'mileszs/ack.vim'                          " Find in all files
Plug 'brooth/far.vim'                           " Find and replace in all files
Plug 'ctrlpvim/ctrlp.vim'                       " Fuzzy finder
Plug 'MattesGroeger/vim-bookmarks'              " Bookmarks in code

" File tools
Plug 'danro/rename.vim'                         " Rename the current file with :Rename

" Html tools
Plug 'mattn/emmet-vim'                          " Very cool html snippets
Plug 'gregsexton/MatchTag'                      " Highlight matching html tag

" Syntax tools
Plug 'w0rp/ale'                                 " Syntax checker
Plug 'prettier/vim-prettier'                    " Prettier JS
Plug 'leafgarland/typescript-vim'               " Typescript syntax
Plug 'mxw/vim-jsx'                              " Jsx syntax
Plug 'pangloss/vim-javascript'                  " Improved JS syntax
Plug 'vmchale/ion-vim'                          " Ion shell syntax
Plug 'tkztmk/vim-vala'                          " Vala syntax
Plug 'ternjs/tern_for_vim'                      " Analize JS to provide autocompletion

" UI
Plug 'vim-airline/vim-airline'                  " Airline status bar
Plug 'junegunn/goyo.vim'                        " Zen mode

" Colors
" Plug 'pablopunk/transparent.vim'                " Make vim transparent
Plug 'morhetz/gruvbox'                          " gruvbox colors

" End of plugins
call plug#end()

"
" Settings after plugins
"

" Colors configuration
if has('nvim')
  set termguicolors
endif
set background=dark
colorscheme gruvbox
" Italic comments
hi Comment gui=italic
" Search terms underlined (no bg)
hi Search guifg=orange guibg=NONE gui=underline
" Current line color
hi CursorLine guibg=#3d3d3d

" Airline config
let g:airline#extensions#tabline#enabled = 1
let g:airline#extensions#tabline#formatter = 'unique_tail'

" CtrlP config
let g:ctrlp_user_command = 'fd --type file --color never "" %s -E po/'

" Bookmarks config
let g:bookmark_sign = '♥'
hi BookmarkSign guifg=#ff4920 guibg=#3c3836

" Ale config
let g:ale_sign_error = '•'
let g:ale_sign_warning = '•'
let g:ale_lint_on_enter = 1
let g:ale_lint_on_save = 1
let g:ale_fix_on_save = 1
let g:ale_completion_enabled = 1
let g:ale_linters = { 'javascript': [], 'typescript': [] }
let g:ale_fixers = { 'javascript': [], 'typescript': [] }
let g:ale_linters.javascript = ['standard']
let g:ale_fixers.javascript = ['standard']
let g:ale_linters.typescript = ['tsserver', 'standard']
let g:ale_fixers.typescript = ['tslint']
let sd = matchstr(getcwd(), 'superdesk')
if !empty(sd)
  let g:ale_linters.javascript = ['eslint']
  let g:ale_fixers.javascript = ['eslint']
endif


" Ack uses 'ag' instead of 'grep'
let g:ackprg = 'ag --nogroup --column'

" ALLOW JSX SYNTAX IN JS
let g:jsx_ext_required = 0

" Commands
command! ImportES6 :execute "normal! 0ciwimport\<esc>f=hdt'i from \<esc>f)xj0"
command! MetaTag :execute "normal! i<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\<esc>"
command! Eslint
  \ :let g:ale_linters.javascript = ['eslint'] |
  \ :let g:ale_linters.typescript = ['tsserver'] |
  \ :let g:ale_fixers.javascript = ['eslint'] |
  \ :let g:ale_fixers.typescript = ['tslint']
command! Standard
  \ :let g:ale_linters.javascript = ['standard'] |
  \ :let g:ale_linters.typescript = ['standard'] |
  \ :let g:ale_fixers.javascript = ['standard'] |
  \ :let g:ale_fixers.typescript = ['standard']
command! Xo
  \ :let g:ale_linters.javascript = ['xo'] |
  \ :let g:ale_linters.typescript = ['xo'] |
  \ :let g:ale_fixers.javascript = ['xo'] |
  \ :let g:ale_fixers.typescript = ['xo']
command! NoLint
  \ :let g:ale_linters.javascript = [] |
  \ :let g:ale_linters.typescript = [] |
  \ :let g:ale_fixers.javascript = [] |
  \ :let g:ale_fixers.typescript = []
